name: Step - Merge + Features

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Config file (e.g., configs/base_conservative.jsonc)"
        required: true
        default: "configs/base_conservative.jsonc"
      symbol:
        description: "Trading symbol (e.g., BTCUSDT)"
        required: true
        default: "BTCUSDT"
      freq:
        description: "Timeframe (1m, 5m, 1h)"
        required: true
        default: "5m"
  workflow_call:
    inputs:
      config_path:
        description: "Config file path"
        required: true
        type: string
      symbol:
        description: "Trading symbol"
        required: true
        type: string
      freq:
        description: "Timeframe"
        required: true
        type: string

env:
  ACR_IMAGE: itbacr.azurecr.io/itb-bot

jobs:
  merge_features:
    name: Merge + Features
    runs-on: ubuntu-latest
    environment: dev
    container:
      image: itbacr.azurecr.io/itb-bot:dev-training
      credentials:
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    env:
      CONFIG: ${{ inputs.config_path || github.event.inputs.config_path || 'configs/base_conservative.jsonc' }}
      SYMBOL: ${{ inputs.symbol || github.event.inputs.symbol || 'BTCUSDT' }}
      FREQ: ${{ inputs.freq || github.event.inputs.freq || '5m' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Azure CLI
        run: |
          apt-get update && apt-get install -y curl
          curl -sL https://aka.ms/InstallAzureCLIDeb | bash

      - name: Download data from Azure Files
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "ðŸ“¥ Downloading from share: $SHARE_NAME/${SYMBOL}"
          mkdir -p "$LOCAL_DIR"

          az storage file download-batch \
            --account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --source "$SHARE_NAME/${SYMBOL}" \
            --destination "$LOCAL_DIR"

      - name: Debug inputs
        run: |
          echo "CONFIG=$CONFIG"
          echo "SYMBOL=$SYMBOL"
          echo "FREQ=$FREQ"
          echo "--- Directory structure ---"
          ls -la "./DATA_ITB_${FREQ}/" || echo "Directory not found"
          ls -la "./DATA_ITB_${FREQ}/${SYMBOL}/" || echo "Symbol directory not found"

      - name: Run merge
        run: |
          echo "ðŸ“Š Running merge: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.merge -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Run features
        run: |
          echo "ðŸ”§ Running features: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.features -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Upload results to Azure Files
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "ðŸ“¤ Uploading to share: $SHARE_NAME/${SYMBOL}"
          az storage file upload-batch \
            --account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --destination "$SHARE_NAME" \
            --destination-path "$SYMBOL" \
            --source "$LOCAL_DIR"
