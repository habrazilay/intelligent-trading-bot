name: Step - Merge + Features

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Config file (e.g., configs/base_conservative.jsonc)"
        required: true
        default: "configs/base_conservative.jsonc"
  workflow_call:
    inputs:
      config_path:
        description: "Config file path"
        required: true
        type: string
      image_tag:
        description: "Image tag (unused, kept for compatibility)"
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  merge_features:
    name: Merge + Features
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-train.txt

      - name: Download data from Azure Files
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          # Install Azure CLI storage extension
          az extension add --name storage-preview 2>/dev/null || true

          # Download data files from Azure File Share
          echo "üì• Downloading data from Azure Files..."
          az storage file download-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --source data-itb-1m \
            --destination ./DATA_ITB_1m \
            --pattern "*/klines.*" || echo "‚ö†Ô∏è No data files found, continuing..."

      - name: Run merge
        run: |
          CONFIG="${{ inputs.config_path || github.event.inputs.config_path }}"
          echo "üìä Running merge with config: $CONFIG"
          python -m scripts.merge -c "$CONFIG"

      - name: Run features
        run: |
          CONFIG="${{ inputs.config_path || github.event.inputs.config_path }}"
          echo "üîß Running features with config: $CONFIG"
          python -m scripts.features -c "$CONFIG"

      - name: Upload results to Azure Files
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          echo "üì§ Uploading results to Azure Files..."
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --destination data-itb-1m \
            --source ./DATA_ITB_1m \
            --pattern "*/features.*" || echo "‚ö†Ô∏è Upload failed"
