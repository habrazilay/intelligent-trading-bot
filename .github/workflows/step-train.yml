name: Step - Train

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Config file (e.g., configs/base_conservative.jsonc)"
        required: true
        default: "configs/base_conservative.jsonc"
      symbol:
        description: "Trading symbol (e.g., BTCUSDT)"
        required: true
        default: "BTCUSDT"
      freq:
        description: "Timeframe (1m, 5m, 1h)"
        required: true
        default: "5m"
  workflow_call:
    inputs:
      config_path:
        description: "Config file path"
        required: true
        type: string
      symbol:
        description: "Trading symbol"
        required: true
        type: string
      freq:
        description: "Timeframe"
        required: true
        type: string

jobs:
  train:
    name: Train Models
    runs-on: ubuntu-latest
    environment: dev
    container:
      image: ${{ vars.ACR_LOGIN_SERVER }}/itb-bot:dev-training
      credentials:
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
    env:
      CONFIG: ${{ inputs.config_path || github.event.inputs.config_path || 'configs/base_conservative.jsonc' }}
      SYMBOL: ${{ inputs.symbol || github.event.inputs.symbol || 'BTCUSDT' }}
      FREQ: ${{ inputs.freq || github.event.inputs.freq || '5m' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download data from Azure Files
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "ðŸ“¥ Downloading from share: $SHARE_NAME/${SYMBOL}"
          mkdir -p "$LOCAL_DIR"

          az storage file download-batch \
            --account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --source "$SHARE_NAME/${SYMBOL}" \
            --destination "$LOCAL_DIR"

      - name: Run train
        run: |
          echo "ðŸ¤– Running train: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.train -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Upload models to Azure Files
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "ðŸ“¤ Uploading to share: $SHARE_NAME/${SYMBOL}"
          az storage file upload-batch \
            --account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --destination "$SHARE_NAME" \
            --destination-path "$SYMBOL" \
            --source "$LOCAL_DIR"
