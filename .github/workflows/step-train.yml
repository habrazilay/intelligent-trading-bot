name: Step - Train

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Config file (e.g., configs/base_conservative.jsonc)"
        required: true
        default: "configs/base_conservative.jsonc"
      symbol:
        description: "Trading symbol (e.g., BTCUSDT)"
        required: true
        default: "BTCUSDT"
      freq:
        description: "Timeframe (1m, 5m, 1h)"
        required: true
        default: "5m"
  workflow_call:
    inputs:
      config_path:
        description: "Config file path"
        required: true
        type: string
      symbol:
        description: "Trading symbol"
        required: true
        type: string
      freq:
        description: "Timeframe"
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  train:
    name: Train Models
    runs-on: ubuntu-latest
    env:
      CONFIG: ${{ inputs.config_path || github.event.inputs.config_path || 'configs/base_conservative.jsonc' }}
      SYMBOL: ${{ inputs.symbol || github.event.inputs.symbol || 'BTCUSDT' }}
      FREQ: ${{ inputs.freq || github.event.inputs.freq || '5m' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-train.txt

      - name: Download data from Azure Files
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "üì• Downloading from share: $SHARE_NAME/${SYMBOL}"
          mkdir -p "$LOCAL_DIR"

          az storage file download-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --source "$SHARE_NAME/${SYMBOL}" \
            --destination "$LOCAL_DIR" \
            || echo "‚ö†Ô∏è No data files found"

      - name: Run train
        run: |
          echo "ü§ñ Running train: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.train -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Upload models to Azure Files
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "üì§ Uploading to share: $SHARE_NAME/${SYMBOL}"
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --destination "$SHARE_NAME" \
            --destination-path "$SYMBOL" \
            --source "$LOCAL_DIR" \
            || echo "‚ö†Ô∏è Upload completed"
