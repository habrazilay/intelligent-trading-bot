name: Run Full Pipeline in Azure Container Instance

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Trading symbol'
        required: true
        type: choice
        options:
          - BTCUSDT
          - ETHUSDT
          - XRPUSDT
          - BNBUSDT
        default: 'BTCUSDT'
      freq:
        description: 'Timeframe (1m, 5m, 1h)'
        required: true
        type: choice
        options:
          - 1m
          - 5m
          - 1h
        default: '5m'
      strategy:
        description: 'Strategy config'
        required: true
        type: choice
        options:
          - conservative
          - aggressive
          - quick_profit
        default: 'conservative'
      image_tag:
        description: 'Docker image tag (leave empty for dev-training)'
        required: false
        default: ''
      keep_container:
        description: 'Keep container after completion (for debugging)'
        required: false
        type: boolean
        default: true
      location:
        description: 'Azure region (leave empty for resource group default)'
        required: false
        default: ''
      skip_file_mount:
        description: 'Skip Azure File mount (for debugging ACI issues)'
        required: false
        type: boolean
        default: false
      force_full:
        description: 'Force full pipeline (ignore cache)'
        required: false
        type: boolean
        default: false
      cache_days_merge:
        description: 'Days before re-running merge (default: 7)'
        required: false
        default: '7'
      cache_days_features:
        description: 'Days before re-running features (default: 1)'
        required: false
        default: '1'

jobs:
  run-pipeline:
    name: Full Pipeline in ACI
    runs-on: ubuntu-latest
    environment: dev
    env:
      SYMBOL: ${{ github.event.inputs.symbol }}
      FREQ: ${{ github.event.inputs.freq }}
      STRATEGY: ${{ github.event.inputs.strategy }}
      CONFIG_PATH: configs/base_${{ github.event.inputs.strategy }}.jsonc
      IMAGE_TAG: ${{ github.event.inputs.image_tag || 'dev-training' }}
      ACR_IMAGE: ${{ vars.ACR_LOGIN_SERVER }}/itb-bot

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables
        id: vars
        run: |
          # Single shared container - can run any symbol/freq/strategy
          CONTAINER_NAME="itb-pipeline-runner"

          # Data mount path for current freq
          DATA_MOUNT="/app/DATA_ITB_${FREQ}"

          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT
          echo "data_mount=${DATA_MOUNT}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Container: ${CONTAINER_NAME}"
          echo "ðŸŽ¯ Config: ${CONFIG_PATH}"
          echo "ðŸª™ Symbol: ${SYMBOL}"
          echo "â±ï¸ Freq: ${FREQ}"

      - name: Check existing container
        id: cleanup
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          # Check if container exists and get its state
          CONTAINER_STATE=$(az container show \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "")

          echo "container_state=${CONTAINER_STATE}" >> $GITHUB_OUTPUT

          if [ -z "$CONTAINER_STATE" ]; then
            echo "âœ… No existing container found"
            echo "reuse_container=false" >> $GITHUB_OUTPUT
          elif [ "$CONTAINER_STATE" = "Running" ]; then
            echo "â™»ï¸ Found running container - will reuse it!"
            echo "reuse_container=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ§¹ Found container in state '$CONTAINER_STATE' - deleting..."
            az container delete \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --yes
            echo "â³ Waiting for deletion..."
            sleep 10
            echo "reuse_container=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify resources and create container
        if: steps.cleanup.outputs.reuse_container != 'true'
        timeout-minutes: 15
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          # Get storage account location (must match ACI location for file share mount)
          STORAGE_LOCATION=$(az storage account show \
            --name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --query "primaryLocation" -o tsv)

          # Use storage account location to ensure file share mount works
          if [ -n "${{ github.event.inputs.location }}" ]; then
            LOCATION="${{ github.event.inputs.location }}"
            echo "âš ï¸  Using custom location: $LOCATION"
            echo "    Storage account is in: $STORAGE_LOCATION"
          else
            LOCATION="$STORAGE_LOCATION"
          fi

          echo ""
          echo "ðŸ” Checking which file shares exist..."

          # Check which file shares exist
          SHARES_1M=$(az storage share exists --name data-itb-1m --account-name ${{ vars.AZURE_STORAGE_ACCOUNT }} --account-key ${{ secrets.AZURE_STORAGE_KEY }} --query exists -o tsv 2>/dev/null || echo "false")
          SHARES_5M=$(az storage share exists --name data-itb-5m --account-name ${{ vars.AZURE_STORAGE_ACCOUNT }} --account-key ${{ secrets.AZURE_STORAGE_KEY }} --query exists -o tsv 2>/dev/null || echo "false")
          SHARES_1H=$(az storage share exists --name data-itb-1h --account-name ${{ vars.AZURE_STORAGE_ACCOUNT }} --account-key ${{ secrets.AZURE_STORAGE_KEY }} --query exists -o tsv 2>/dev/null || echo "false")

          echo "   data-itb-1m: $SHARES_1M"
          echo "   data-itb-5m: $SHARES_5M"
          echo "   data-itb-1h: $SHARES_1H"

          # Build volume mounts and volumes dynamically
          VOLUME_MOUNTS=""
          VOLUMES=""
          MOUNTS_LIST=""

          if [ "$SHARES_1M" = "true" ]; then
            VOLUME_MOUNTS="${VOLUME_MOUNTS}
                - name: data-1m
                  mountPath: /app/DATA_ITB_1m"
            VOLUMES="${VOLUMES}
            - name: data-1m
              azureFile:
                shareName: data-itb-1m
                storageAccountName: ${{ vars.AZURE_STORAGE_ACCOUNT }}
                storageAccountKey: ${{ secrets.AZURE_STORAGE_KEY }}"
            MOUNTS_LIST="${MOUNTS_LIST} data-itb-1m"
          fi

          if [ "$SHARES_5M" = "true" ]; then
            VOLUME_MOUNTS="${VOLUME_MOUNTS}
                - name: data-5m
                  mountPath: /app/DATA_ITB_5m"
            VOLUMES="${VOLUMES}
            - name: data-5m
              azureFile:
                shareName: data-itb-5m
                storageAccountName: ${{ vars.AZURE_STORAGE_ACCOUNT }}
                storageAccountKey: ${{ secrets.AZURE_STORAGE_KEY }}"
            MOUNTS_LIST="${MOUNTS_LIST} data-itb-5m"
          fi

          if [ "$SHARES_1H" = "true" ]; then
            VOLUME_MOUNTS="${VOLUME_MOUNTS}
                - name: data-1h
                  mountPath: /app/DATA_ITB_1h"
            VOLUMES="${VOLUMES}
            - name: data-1h
              azureFile:
                shareName: data-itb-1h
                storageAccountName: ${{ vars.AZURE_STORAGE_ACCOUNT }}
                storageAccountKey: ${{ secrets.AZURE_STORAGE_KEY }}"
            MOUNTS_LIST="${MOUNTS_LIST} data-itb-1h"
          fi

          if [ -z "$MOUNTS_LIST" ]; then
            echo "âŒ Error: No file shares found! At least one data share must exist."
            exit 1
          fi

          echo ""
          echo "ðŸš€ Creating container $CONTAINER_NAME..."
          echo "   Image: ${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}"
          echo "   Resource Group: ${{ vars.AZURE_RESOURCE_GROUP }}"
          echo "   Location: $LOCATION"
          echo "   Storage: ${{ vars.AZURE_STORAGE_ACCOUNT }} ($STORAGE_LOCATION)"
          echo "   Mounts:${MOUNTS_LIST}"
          echo ""

          # Create YAML config for container with conditional file share mounts
          cat > /tmp/aci-config.yaml << EOF
          apiVersion: 2021-09-01
          location: $LOCATION
          name: $CONTAINER_NAME
          properties:
            containers:
            - name: pipeline
              properties:
                image: ${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}
                command:
                - tail
                - -f
                - /dev/null
                resources:
                  requests:
                    cpu: 2
                    memoryInGb: 4
                volumeMounts:${VOLUME_MOUNTS}
            imageRegistryCredentials:
            - server: ${{ vars.ACR_LOGIN_SERVER }}
              username: ${{ secrets.ACR_USERNAME }}
              password: ${{ secrets.ACR_PASSWORD }}
            osType: Linux
            restartPolicy: Never
            volumes:${VOLUMES}
          type: Microsoft.ContainerInstance/containerGroups
          EOF

          # Create container from YAML
          az container create \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --file /tmp/aci-config.yaml

          echo ""
          echo "âœ… Container created, checking status..."
          az container show \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --query "{state:provisioningState,containerState:containers[0].instanceView.currentState.state}" \
            -o table

      - name: Reuse existing container
        if: steps.cleanup.outputs.reuse_container == 'true'
        run: echo "â™»ï¸ Reusing existing running container"

      - name: Wait for container to be running
        if: steps.cleanup.outputs.reuse_container != 'true'
        timeout-minutes: 5
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "â³ Waiting for container to be running..."

          for i in {1..20}; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "Waiting")

            echo "[$i] Container state: $STATE"
            if [ "$STATE" = "Running" ]; then
              echo "âœ… Container is running!"
              break
            fi
            sleep 10
          done

      - name: Check cache and determine steps to run
        id: cache
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"
          SYMBOL="${{ env.SYMBOL }}"
          STRATEGY="${{ env.STRATEGY }}"
          FORCE_FULL="${{ github.event.inputs.force_full }}"
          CACHE_DAYS_MERGE="${{ github.event.inputs.cache_days_merge || '7' }}"
          CACHE_DAYS_FEATURES="${{ github.event.inputs.cache_days_features || '1' }}"

          echo "ðŸ” Checking cache status..."
          echo "   Force full: $FORCE_FULL"
          echo "   Merge cache days: $CACHE_DAYS_MERGE"
          echo "   Features cache days: $CACHE_DAYS_FEATURES"

          if [ "$FORCE_FULL" = "true" ]; then
            echo "âš ï¸ Force full enabled - running all steps"
            echo "run_merge=true" >> $GITHUB_OUTPUT
            echo "run_features=true" >> $GITHUB_OUTPUT
            echo "run_labels=true" >> $GITHUB_OUTPUT
            echo "run_train=true" >> $GITHUB_OUTPUT
            echo "run_predict=true" >> $GITHUB_OUTPUT
            echo "run_signals=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check file ages using find inside the container (simpler than Python)
          DATA_DIR="${DATA_MOUNT}/${SYMBOL}"

          # Get file ages in days using find -mtime
          get_newest_age() {
            local pattern=$1
            az container exec \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --exec-command "find ${DATA_DIR} -name '${pattern}' -type f -printf '%T@\n' 2>/dev/null | sort -rn | head -1" 2>/dev/null | tr -d '\r\n' || echo ""
          }

          # Get last strategy from marker file
          LAST_STRATEGY=$(az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "cat ${DATA_DIR}/.last_strategy 2>/dev/null || echo ''" 2>/dev/null | tr -d '\r\n' || echo "")

          echo "ðŸ“… Last strategy: '$LAST_STRATEGY'"
          echo "   Current strategy: '$STRATEGY'"

          # Default: run everything
          RUN_MERGE="true"
          RUN_FEATURES="true"
          RUN_LABELS="true"
          RUN_TRAIN="true"
          RUN_PREDICT="true"
          RUN_SIGNALS="true"

          # Check if strategy changed - if so, must re-run features onwards
          STRATEGY_CHANGED="false"
          if [ -n "$LAST_STRATEGY" ] && [ "$LAST_STRATEGY" != "$STRATEGY" ]; then
            STRATEGY_CHANGED="true"
            echo "âš ï¸ Strategy changed - will re-run features onwards"
          fi

          echo ""
          echo "ðŸ“‹ Steps to run:"
          echo "   Merge: $RUN_MERGE"
          echo "   Features: $RUN_FEATURES"
          echo "   Labels: $RUN_LABELS"
          echo "   Train: $RUN_TRAIN"
          echo "   Predict: $RUN_PREDICT"
          echo "   Signals: $RUN_SIGNALS"

          echo "run_merge=$RUN_MERGE" >> $GITHUB_OUTPUT
          echo "run_features=$RUN_FEATURES" >> $GITHUB_OUTPUT
          echo "run_labels=$RUN_LABELS" >> $GITHUB_OUTPUT
          echo "run_train=$RUN_TRAIN" >> $GITHUB_OUTPUT
          echo "run_predict=$RUN_PREDICT" >> $GITHUB_OUTPUT
          echo "run_signals=$RUN_SIGNALS" >> $GITHUB_OUTPUT

      - name: Run merge
        if: steps.cache.outputs.run_merge == 'true'
        timeout-minutes: 10
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸ“Š Step 1/6: Merge..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "python -m scripts.merge -c ${{ env.CONFIG_PATH }} --symbol ${{ env.SYMBOL }} --freq ${{ env.FREQ }}"

      - name: Skip merge
        if: steps.cache.outputs.run_merge != 'true'
        run: echo "â­ï¸ Skipping merge (cached)"

      - name: Run features
        if: steps.cache.outputs.run_features == 'true'
        timeout-minutes: 10
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸ§® Step 2/6: Features..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "python -m scripts.features -c ${{ env.CONFIG_PATH }} --symbol ${{ env.SYMBOL }} --freq ${{ env.FREQ }}"

      - name: Skip features
        if: steps.cache.outputs.run_features != 'true'
        run: echo "â­ï¸ Skipping features (cached)"

      - name: Run labels
        if: steps.cache.outputs.run_labels == 'true'
        timeout-minutes: 10
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸ·ï¸ Step 3/6: Labels..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "python -m scripts.labels -c ${{ env.CONFIG_PATH }} --symbol ${{ env.SYMBOL }} --freq ${{ env.FREQ }}"

      - name: Skip labels
        if: steps.cache.outputs.run_labels != 'true'
        run: echo "â­ï¸ Skipping labels (cached)"

      - name: Run train
        if: steps.cache.outputs.run_train == 'true'
        timeout-minutes: 30
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸŽ“ Step 4/6: Train..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "python -m scripts.train -c ${{ env.CONFIG_PATH }} --symbol ${{ env.SYMBOL }} --freq ${{ env.FREQ }}"

      - name: Skip train
        if: steps.cache.outputs.run_train != 'true'
        run: echo "â­ï¸ Skipping train (cached)"

      - name: Run predict
        if: steps.cache.outputs.run_predict == 'true'
        timeout-minutes: 10
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸ”® Step 5/6: Predict..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "python -m scripts.predict -c ${{ env.CONFIG_PATH }} --symbol ${{ env.SYMBOL }} --freq ${{ env.FREQ }}"

      - name: Run signals
        if: steps.cache.outputs.run_signals == 'true'
        timeout-minutes: 10
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸš¦ Step 6/6: Signals..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "python -m scripts.signals -c ${{ env.CONFIG_PATH }} --symbol ${{ env.SYMBOL }} --freq ${{ env.FREQ }}"

      - name: Save strategy marker
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"
          SYMBOL="${{ env.SYMBOL }}"
          STRATEGY="${{ env.STRATEGY }}"
          echo "ðŸ’¾ Saving strategy marker..."
          az container exec \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --exec-command "echo '${STRATEGY}' > ${DATA_MOUNT}/${SYMBOL}/.last_strategy"

          echo ""
          echo "âœ… Pipeline complete!"

      - name: Get container info and logs
        if: always()
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          echo "ðŸ“Š Container info:"
          az container show \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --query "{state:provisioningState, containerState:containers[0].instanceView.currentState, events:containers[0].instanceView.events}" \
            -o json 2>/dev/null || echo "âš ï¸ Container info not available"

          echo ""
          echo "ðŸ“œ Container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" 2>/dev/null || echo "âš ï¸ Logs not available"

      - name: Cleanup container
        if: always() && github.event.inputs.keep_container != 'true'
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          echo "ðŸ§¹ Cleaning up container..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes || true

      - name: Keep container notice
        if: always() && github.event.inputs.keep_container == 'true'
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸ“¦ Container kept for debugging: $CONTAINER_NAME"
          echo "   View logs: az container logs --name $CONTAINER_NAME --resource-group ${{ vars.AZURE_RESOURCE_GROUP }}"
          echo "   Delete: az container delete --name $CONTAINER_NAME --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} --yes"

      - name: Pipeline Summary
        if: always()
        run: |
          echo "## ðŸš€ ACI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Symbol:** \`${{ env.SYMBOL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timeframe:** \`${{ env.FREQ }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** \`${{ env.STRATEGY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pipeline Steps" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.cache.outputs.run_merge }}" = "true" ]; then
            echo "| 1. Merge | âœ… Executed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 1. Merge | â­ï¸ Skipped (cached) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cache.outputs.run_features }}" = "true" ]; then
            echo "| 2. Features | âœ… Executed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 2. Features | â­ï¸ Skipped (cached) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cache.outputs.run_labels }}" = "true" ]; then
            echo "| 3. Labels | âœ… Executed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 3. Labels | â­ï¸ Skipped (cached) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cache.outputs.run_train }}" = "true" ]; then
            echo "| 4. Train | âœ… Executed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 4. Train | â­ï¸ Skipped (cached) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cache.outputs.run_predict }}" = "true" ]; then
            echo "| 5. Predict | âœ… Executed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 5. Predict | â­ï¸ Skipped (cached) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ steps.cache.outputs.run_signals }}" = "true" ]; then
            echo "| 6. Signals | âœ… Executed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| 6. Signals | â­ï¸ Skipped (cached) |" >> $GITHUB_STEP_SUMMARY
          fi
