name: Run Full Pipeline in Azure Container Instance

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Trading symbol (e.g., BTCUSDT, ETHUSDT)'
        required: true
        default: 'BTCUSDT'
      freq:
        description: 'Timeframe (1m, 5m, 1h)'
        required: true
        type: choice
        options:
          - 1m
          - 5m
          - 1h
        default: '5m'
      strategy:
        description: 'Strategy config'
        required: true
        type: choice
        options:
          - conservative
          - aggressive
          - staging
          - quick
        default: 'conservative'
      image_tag:
        description: 'Docker image tag (leave empty for dev-training)'
        required: false
        default: ''
      keep_container:
        description: 'Keep container after completion (for debugging)'
        required: false
        type: boolean
        default: false
      location:
        description: 'Azure region (leave empty for resource group default)'
        required: false
        default: ''
      skip_file_mount:
        description: 'Skip Azure File mount (for debugging ACI issues)'
        required: false
        type: boolean
        default: false

jobs:
  run-pipeline:
    name: Full Pipeline in ACI
    runs-on: ubuntu-latest
    environment: dev
    env:
      SYMBOL: ${{ github.event.inputs.symbol }}
      FREQ: ${{ github.event.inputs.freq }}
      STRATEGY: ${{ github.event.inputs.strategy }}
      CONFIG_PATH: configs/base_${{ github.event.inputs.strategy }}.jsonc
      IMAGE_TAG: ${{ github.event.inputs.image_tag || 'dev-training' }}
      ACR_IMAGE: ${{ vars.ACR_LOGIN_SERVER }}/itb-bot

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables
        id: vars
        run: |
          CONTAINER_NAME="itb-pipeline-${SYMBOL,,}-${FREQ}"
          FILE_SHARE="data-itb-${FREQ}"
          DATA_MOUNT="/app/DATA_ITB_${FREQ}"

          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT
          echo "file_share=${FILE_SHARE}" >> $GITHUB_OUTPUT
          echo "data_mount=${DATA_MOUNT}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Container: ${CONTAINER_NAME}"
          echo "ðŸ“ File Share: ${FILE_SHARE}"
          echo "ðŸŽ¯ Config: ${CONFIG_PATH}"

      - name: Check and delete old container
        id: cleanup
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          # Check if container exists
          EXISTS=$(az container show \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --query "name" -o tsv 2>/dev/null || echo "")

          if [ -n "$EXISTS" ]; then
            echo "ðŸ§¹ Found existing container, deleting..."
            az container delete \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --yes

            # Wait for deletion to complete
            echo "â³ Waiting for deletion..."
            sleep 10
          else
            echo "âœ… No existing container found"
          fi

      - name: Verify resources and create container
        timeout-minutes: 15
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          FILE_SHARE="${{ steps.vars.outputs.file_share }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"

          # Get storage account location (must match ACI location for file share mount)
          STORAGE_LOCATION=$(az storage account show \
            --name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --query "primaryLocation" -o tsv)

          # Use storage account location to ensure file share mount works
          if [ -n "${{ github.event.inputs.location }}" ]; then
            LOCATION="${{ github.event.inputs.location }}"
            echo "âš ï¸  Using custom location: $LOCATION"
            echo "    Storage account is in: $STORAGE_LOCATION"
          else
            LOCATION="$STORAGE_LOCATION"
          fi

          echo ""
          echo "ðŸš€ Creating container $CONTAINER_NAME..."
          echo "   Image: ${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}"
          echo "   Resource Group: ${{ vars.AZURE_RESOURCE_GROUP }}"
          echo "   Location: $LOCATION"
          echo "   Storage: ${{ vars.AZURE_STORAGE_ACCOUNT }} ($STORAGE_LOCATION)"
          echo ""

          # Create container with Azure File mount
          az container create \
            --location "$LOCATION" \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --image "${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}" \
            --os-type Linux \
            --registry-login-server "${{ vars.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 2 \
            --memory 4 \
            --environment-variables \
              CONFIG_PATH="${{ env.CONFIG_PATH }}" \
              SYMBOL="${{ env.SYMBOL }}" \
              FREQ="${{ env.FREQ }}" \
            --azure-file-volume-share-name "$FILE_SHARE" \
            --azure-file-volume-account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "$DATA_MOUNT" \
            --command-line "sleep 60"

          echo ""
          echo "âœ… Container created, checking status..."
          az container show \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --query "{state:provisioningState,containerState:containers[0].instanceView.currentState.state}" \
            -o table

      - name: Wait for container to complete
        timeout-minutes: 10
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          echo "â³ Waiting for container to complete..."
          COUNTER=0

          while true; do
            # Get both provisioning state and container state
            RESULT=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --query "{prov:provisioningState, state:containers[0].instanceView.currentState.state, exit:containers[0].instanceView.currentState.exitCode}" \
              -o json 2>/dev/null || echo '{"prov":"Unknown","state":"Unknown","exit":null}')

            PROV_STATE=$(echo "$RESULT" | jq -r '.prov')
            CONTAINER_STATE=$(echo "$RESULT" | jq -r '.state')
            EXIT_CODE=$(echo "$RESULT" | jq -r '.exit')

            echo "[$COUNTER] Provisioning: $PROV_STATE | Container: $CONTAINER_STATE | Exit: $EXIT_CODE"

            # Check for terminal states
            if [ "$CONTAINER_STATE" = "Terminated" ]; then
              echo ""
              echo "Container finished with exit code: $EXIT_CODE"
              if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "null" ]; then
                echo "âŒ Container failed!"
                exit 1
              fi
              echo "âœ… Container completed successfully!"
              break
            fi

            # Check for provisioning failures
            if [ "$PROV_STATE" = "Failed" ]; then
              echo "âŒ Provisioning failed!"
              exit 1
            fi

            COUNTER=$((COUNTER + 1))
            sleep 15
          done

      - name: Get container info and logs
        if: always()
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          echo "ðŸ“Š Container info:"
          az container show \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --query "{state:provisioningState, containerState:containers[0].instanceView.currentState, events:containers[0].instanceView.events}" \
            -o json 2>/dev/null || echo "âš ï¸ Container info not available"

          echo ""
          echo "ðŸ“œ Container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" 2>/dev/null || echo "âš ï¸ Logs not available"

      - name: Cleanup container
        if: always() && github.event.inputs.keep_container != 'true'
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"

          echo "ðŸ§¹ Cleaning up container..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes || true

      - name: Keep container notice
        if: always() && github.event.inputs.keep_container == 'true'
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "ðŸ“¦ Container kept for debugging: $CONTAINER_NAME"
          echo "   View logs: az container logs --name $CONTAINER_NAME --resource-group ${{ vars.AZURE_RESOURCE_GROUP }}"
          echo "   Delete: az container delete --name $CONTAINER_NAME --resource-group ${{ vars.AZURE_RESOURCE_GROUP }} --yes"

      - name: Pipeline Summary
        run: |
          echo "## ðŸš€ ACI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Symbol:** \`${{ env.SYMBOL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timeframe:** \`${{ env.FREQ }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** \`${{ env.STRATEGY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.ACR_IMAGE }}:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Steps Executed" >> $GITHUB_STEP_SUMMARY
          echo "1. Merge" >> $GITHUB_STEP_SUMMARY
          echo "2. Features" >> $GITHUB_STEP_SUMMARY
          echo "3. Labels" >> $GITHUB_STEP_SUMMARY
          echo "4. Train" >> $GITHUB_STEP_SUMMARY
          echo "5. Predict" >> $GITHUB_STEP_SUMMARY
          echo "6. Signals" >> $GITHUB_STEP_SUMMARY
