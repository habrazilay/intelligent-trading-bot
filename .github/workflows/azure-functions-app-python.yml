name: Run grouped pipeline on Azure ACI (Dedicated, 1 container per job, ACR)

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Path to JSONC config file (e.g. configs/btcusdt_1m_dev.jsonc)"
        required: true
        default: "configs/btcusdt_1m_dev.jsonc"
      image_tag:
        description: "Image tag (just the tag, e.g. amd64-1764313462)"
        required: true
        default: "amd64-1764313462"
      run_download:
        description: "Run scripts.download_binance inside Azure (Binance may block ACI IP). If false, assume klines.parquet already exists in the File Share."
        required: true
        default: "false"

env:
  ACR_LOGIN_SERVER: itbacr.azurecr.io
  ACR_REPOSITORY: itb-bot
  DOCKER_IMAGE: itbacr.azurecr.io/itb-bot:${{ github.event.inputs.image_tag }}
  AZURE_RESOURCE_GROUP: rg-itb-dev
  AZURE_CONTAINER_PREFIX: itb-bot
  AZURE_STORAGE_ACCOUNT: stitbdev
  AZURE_FILE_SHARE: data-itb-1m
  DATA_MOUNT_PATH: /app/DATA_ITB_1m

jobs:
  download:
    runs-on: ubuntu-latest
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}
      RUN_DOWNLOAD: ${{ github.event.inputs.run_download }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Optional download_binance in Azure Container Instance (Dedicated)
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-download

          echo "CONFIG_PATH=$CONFIG_PATH"
          echo "RUN_DOWNLOAD=$RUN_DOWNLOAD"

          if [ "$RUN_DOWNLOAD" != "true" ]; then
            echo "â­ï¸  Skipping download_binance in Azure (RUN_DOWNLOAD=false). Assuming klines.parquet already exists in File Share."
            exit 0
          fi

          echo "ðŸ§¹ Deleting previous download container (if exists)..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --yes || true

          echo "â¬‡ï¸  Creating Dedicated ACI container $CONTAINER_NAME using image $DOCKER_IMAGE..."
          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --image "$DOCKER_IMAGE" \
            --os-type Linux \
            --registry-login-server "${{ env.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY="${{ secrets.BINANCE_API_KEY }}" \
              BINANCE_API_SECRET="${{ secrets.BINANCE_API_SECRET }}" \
            --azure-file-volume-share-name "${{ env.AZURE_FILE_SHARE }}" \
            --azure-file-volume-account-name "${{ env.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "${{ env.DATA_MOUNT_PATH }}" \
            --no-wait \
            --command-line "python -m scripts.download_binance -c $CONFIG_PATH"

          echo "â³ Waiting for download container state to reach a final status..."
          for i in {1..60}; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --query 'instanceView.state' -o tsv 2>/dev/null || echo "Pending")
            echo "[$i] Container state: $STATE"
            if [ "$STATE" = "Terminated" ] || [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo "ðŸ“œ Download container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}"

  preprocess:
    runs-on: ubuntu-latest
    needs: download
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run merge_new + features_new + labels_new in Azure Container Instance (Dedicated)
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-preprocess

          echo "CONFIG_PATH=$CONFIG_PATH"
          echo "ðŸ§¹ Deleting previous preprocess container (if exists)..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --yes || true

          echo "ðŸ”„ Creating preprocess container $CONTAINER_NAME with image $DOCKER_IMAGE..."
          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --image "$DOCKER_IMAGE" \
            --os-type Linux \
            --registry-login-server "${{ env.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --azure-file-volume-share-name "${{ env.AZURE_FILE_SHARE }}" \
            --azure-file-volume-account-name "${{ env.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "${{ env.DATA_MOUNT_PATH }}" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              echo \"ðŸ”„ Running merge_new...\"
              python -m scripts.merge_new -c \"$CONFIG_PATH\"

              echo \"ðŸ§® Running features_new...\"
              python -m scripts.features_new -c \"$CONFIG_PATH\"

              echo \"ðŸ·  Running labels_new...\"
              python -m scripts.labels_new -c \"$CONFIG_PATH\"

              echo \"âœ… Preprocess (merge+features+labels) completed.\"
            '"

          echo "â³ Waiting for preprocess container final state..."
          for i in {1..60}; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --query 'instanceView.state' -o tsv 2>/dev/null || echo "Pending")
            echo "[$i] Container state: $STATE"
            if [ "$STATE" = "Terminated" ] || [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo "ðŸ“œ Preprocess container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}"

  train:
    runs-on: ubuntu-latest
    needs: preprocess
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run train in Azure Container Instance (Dedicated)
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-train

          echo "CONFIG_PATH=$CONFIG_PATH"
          echo "ðŸ§¹ Deleting previous train container (if exists)..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --yes || true

          echo "ðŸŽ“ Creating train container $CONTAINER_NAME..."
          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --image "$DOCKER_IMAGE" \
            --os-type Linux \
            --registry-login-server "${{ env.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --azure-file-volume-share-name "${{ env.AZURE_FILE_SHARE }}" \
            --azure-file-volume-account-name "${{ env.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "${{ env.DATA_MOUNT_PATH }}" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              echo \"ðŸŽ“ Running train...\"
              python -m scripts.train -c \"$CONFIG_PATH\"
              echo \"âœ… Train completed.\"
            '"

          echo "â³ Waiting for train container final state..."
          for i in {1..60}; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --query 'instanceView.state' -o tsv 2>/dev/null || echo "Pending")
            echo "[$i] Container state: $STATE"
            if [ "$STATE" = "Terminated" ] || [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo "ðŸ“œ Train container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}"

  run_models:
    runs-on: ubuntu-latest
    needs: train
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run predict + signals + output in Azure Container Instance (Dedicated)
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-run

          echo "CONFIG_PATH=$CONFIG_PATH"
          echo "ðŸ§¹ Deleting previous run container (if exists)..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --yes || true

          echo "ðŸš€ Creating run container $CONTAINER_NAME..."
          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --image "$DOCKER_IMAGE" \
            --os-type Linux \
            --registry-login-server "${{ env.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --azure-file-volume-share-name "${{ env.AZURE_FILE_SHARE }}" \
            --azure-file-volume-account-name "${{ env.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "${{ env.DATA_MOUNT_PATH }}" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              echo \"ðŸ”® Running predict...\"
              python -m scripts.predict -c \"$CONFIG_PATH\"

              echo \"ðŸš¦ Running signals...\"
              python -m scripts.signals -c \"$CONFIG_PATH\"

              echo \"ðŸ“¤ Running output...\"
              python -m scripts.output -c \"$CONFIG_PATH\"

              echo \"âœ… Run (predict+signals+output) completed.\"
            '"

          echo "â³ Waiting for run container final state..."
          for i in {1..60}; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --query 'instanceView.state' -o tsv 2>/dev/null || echo "Pending")
            echo "[$i] Container state: $STATE"
            if [ "$STATE" = "Terminated" ] || [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo "ðŸ“œ Run container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}"
