name: Run pipeline on Azure Container Instance (generic config)

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Path to JSONC config file (e.g. configs/btcusdt_1m_dev.jsonc)"
        required: true
        default: "configs/btcusdt_1m_dev.jsonc"
      image_tag:
        description: "Docker image tag to use (e.g. habrazilay/itb-bot:latest)"
        required: true
        default: "habrazilay/itb-bot:latest"

env:
  DOCKER_IMAGE: ${{ github.event.inputs.image_tag }}    # Full image name from Docker Hub
  AZURE_RESOURCE_GROUP: rg-itb-dev                     # Azure resource group (from Terraform)
  AZURE_CONTAINER_PREFIX: itb-bot                      # Prefix for container instances
  AZURE_STORAGE_ACCOUNT: stitbdev                      # Storage account (from Terraform output)
  AZURE_FILE_SHARE: data-itb-1m                        # File share where data is stored
  DATA_MOUNT_PATH: /app/DATA_ITB_1m                    # Must match data_folder in config (relative to /app)

jobs:
  download:
    runs-on: ubuntu-latest
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run download_binance in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-download

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --os-type Linux \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.download_binance -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  merge:
    runs-on: ubuntu-latest
    needs: download
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run merge_new in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-merge

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --os-type Linux \
            --registry-login-server index.docker.io \
            --registry-username ${{ secrets.DOCKERHUB_USER }} \
            --registry-password ${{ secrets.DOCKERHUB_TOKEN }} \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
                BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
                BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.download_binance -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  features:
    runs-on: ubuntu-latest
    needs: merge
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run features_new in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-features

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.features_new -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  labels:
    runs-on: ubuntu-latest
    needs: features
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run labels_new in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-labels

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.labels_new -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  train:
    runs-on: ubuntu-latest
    needs: labels
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run train in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-train

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.train -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  predict:
    runs-on: ubuntu-latest
    needs: train
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run predict in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-predict

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.predict -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  signals:
    runs-on: ubuntu-latest
    needs: predict
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run signals in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-signals

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.signals -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

  output:
    runs-on: ubuntu-latest
    needs: signals
    env:
      CONFIG_PATH: ${{ github.event.inputs.config_path }}

    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run output in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-output

          az container delete \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --yes || true

          az container create \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --image $DOCKER_IMAGE \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              BINANCE_API_KEY=${{ secrets.BINANCE_API_KEY }} \
              BINANCE_API_SECRET=${{ secrets.BINANCE_API_SECRET }} \
            --azure-file-volume-share-name ${{ env.AZURE_FILE_SHARE }} \
            --azure-file-volume-account-name ${{ env.AZURE_STORAGE_ACCOUNT }} \
            --azure-file-volume-account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --azure-file-volume-mount-path ${{ env.DATA_MOUNT_PATH }} \
            --command-line "python -m scripts.output -c $CONFIG_PATH"

          az container wait \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --custom "instanceView.state=='Terminated'"

          az container logs \
            --name $CONTAINER_NAME \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }}
