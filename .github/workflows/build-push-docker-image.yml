name: Build & Push Docker Image

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - build        # Build new image with version
          - promote      # Promote existing image to another env
        default: 'build'
      target:
        description: 'Docker build target'
        required: true
        type: choice
        options:
          - production   # Shadow mode (~400MB)
          - training     # ML training (~600MB)
          - full         # Development (~1.1GB)
        default: 'training'
      version:
        description: 'Version (e.g., 1.2.3) - required for build'
        required: false
        default: ''
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      source_env:
        description: 'Source environment (for promote action only)'
        required: false
        type: choice
        options:
          - dev
          - staging
        default: 'dev'
      push_to:
        description: 'Registry to push'
        required: true
        type: choice
        options:
          - acr
          - dockerhub
          - both
        default: 'acr'

env:
  DOCKERHUB_IMAGE: habrazilay/itb-bot
  ACR_LOGIN_SERVER: ${{ vars.ACR_LOGIN_SERVER }}
  ACR_IMAGE: ${{ vars.ACR_LOGIN_SERVER }}/itb-bot

jobs:
  # =============================================================================
  # BUILD: Create new image with version tag
  # =============================================================================
  build:
    if: github.event.inputs.action == 'build'
    runs-on: ubuntu-latest
    steps:
      - name: Validate version input
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            echo "âŒ Error: Version is required for build action"
            echo "   Example: 1.2.3"
            exit 1
          fi
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Version must be in format X.Y.Z (e.g., 1.2.3)"
            echo "   Got: $VERSION"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate tags
        id: tags
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ENV="${{ github.event.inputs.environment }}"
          TARGET="${{ github.event.inputs.target }}"
          SHORT_SHA=${GITHUB_SHA::7}

          # Target suffix (production has no suffix for backwards compatibility)
          if [ "$TARGET" == "production" ]; then
            TARGET_SUFFIX=""
          else
            TARGET_SUFFIX="-${TARGET}"
          fi

          # Main version tag with environment and target
          if [ "$ENV" == "prod" ]; then
            VERSION_TAG="v${VERSION}${TARGET_SUFFIX}"
          else
            VERSION_TAG="v${VERSION}-${ENV}${TARGET_SUFFIX}"
          fi

          # Full tag with commit SHA for traceability
          FULL_TAG="v${VERSION}-${ENV}${TARGET_SUFFIX}-${SHORT_SHA}"

          # Environment tag (used by workflows)
          ENV_TAG="${ENV}${TARGET_SUFFIX}"

          echo "version_tag=${VERSION_TAG}" >> $GITHUB_OUTPUT
          echo "full_tag=${FULL_TAG}" >> $GITHUB_OUTPUT
          echo "env_tag=${ENV_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "target=${TARGET}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Tags to create:"
          echo "   - ${VERSION_TAG} (main)"
          echo "   - ${FULL_TAG} (with SHA)"
          echo "   - ${ENV_TAG} (environment latest)"
          echo "ðŸŽ¯ Target: ${TARGET}"

      - name: Login to Docker Hub
        if: github.event.inputs.push_to == 'dockerhub' || github.event.inputs.push_to == 'both'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Azure Container Registry
        if: github.event.inputs.push_to == 'acr' || github.event.inputs.push_to == 'both'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build Docker image
        run: |
          docker build \
            --target ${{ github.event.inputs.target }} \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VERSION=${{ github.event.inputs.version }} \
            --build-arg VCS_REF=${{ steps.tags.outputs.short_sha }} \
            --build-arg ENVIRONMENT=${{ github.event.inputs.environment }} \
            -t build-temp \
            .

      - name: Push to Docker Hub
        if: github.event.inputs.push_to == 'dockerhub' || github.event.inputs.push_to == 'both'
        run: |
          # Tag and push version tag
          docker tag build-temp ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.version_tag }}
          docker push ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.version_tag }}

          # Tag and push full tag with SHA
          docker tag build-temp ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.full_tag }}
          docker push ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.full_tag }}

          # Tag and push environment tag
          docker tag build-temp ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.env_tag }}
          docker push ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.env_tag }}

          echo "âœ… Pushed to Docker Hub:"
          echo "   - ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.version_tag }}"
          echo "   - ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.full_tag }}"
          echo "   - ${{ env.DOCKERHUB_IMAGE }}:${{ steps.tags.outputs.env_tag }}"

      - name: Push to Azure Container Registry
        if: github.event.inputs.push_to == 'acr' || github.event.inputs.push_to == 'both'
        run: |
          # Tag and push version tag
          docker tag build-temp ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.version_tag }}
          docker push ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.version_tag }}

          # Tag and push full tag with SHA
          docker tag build-temp ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.full_tag }}
          docker push ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.full_tag }}

          # Tag and push environment tag
          docker tag build-temp ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.env_tag }}
          docker push ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.env_tag }}

          echo "âœ… Pushed to Azure ACR:"
          echo "   - ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.version_tag }}"
          echo "   - ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.full_tag }}"
          echo "   - ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.env_tag }}"

      - name: Build Summary
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ github.event.inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`${{ github.event.inputs.target }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ steps.tags.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags Created" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Purpose |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.tags.outputs.version_tag }}\` | Main version tag |" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.tags.outputs.full_tag }}\` | Version + SHA (immutable) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`${{ steps.tags.outputs.env_tag }}\` | Environment latest |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage in Workflows" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "container:" >> $GITHUB_STEP_SUMMARY
          echo "  image: ${{ env.ACR_IMAGE }}:${{ steps.tags.outputs.env_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # PROMOTE: Re-tag existing image for another environment (no rebuild)
  # =============================================================================
  promote:
    if: github.event.inputs.action == 'promote'
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.environment }}"

          if [ -z "$VERSION" ]; then
            echo "âŒ Error: Version is required for promote action"
            exit 1
          fi

          if [ "$SOURCE" == "$TARGET" ]; then
            echo "âŒ Error: Source and target environment cannot be the same"
            exit 1
          fi

          if [ "$TARGET" == "prod" ] && [ "$SOURCE" != "staging" ]; then
            echo "âš ï¸  Warning: Promoting directly to prod from $SOURCE (not staging)"
          fi

          echo "âœ… Promoting v${VERSION} from ${SOURCE} to ${TARGET}"

      - name: Login to Azure Container Registry
        if: github.event.inputs.push_to == 'acr' || github.event.inputs.push_to == 'both'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Login to Docker Hub
        if: github.event.inputs.push_to == 'dockerhub' || github.event.inputs.push_to == 'both'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Promote in ACR
        if: github.event.inputs.push_to == 'acr' || github.event.inputs.push_to == 'both'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.environment }}"

          # Source tag
          if [ "$SOURCE" == "prod" ]; then
            SOURCE_TAG="v${VERSION}"
          else
            SOURCE_TAG="v${VERSION}-${SOURCE}"
          fi

          # Target tag
          if [ "$TARGET" == "prod" ]; then
            TARGET_TAG="v${VERSION}"
          else
            TARGET_TAG="v${VERSION}-${TARGET}"
          fi

          echo "ðŸ”„ Pulling ${{ env.ACR_IMAGE }}:${SOURCE_TAG}..."
          docker pull ${{ env.ACR_IMAGE }}:${SOURCE_TAG}

          echo "ðŸ·ï¸  Tagging as ${TARGET_TAG}..."
          docker tag ${{ env.ACR_IMAGE }}:${SOURCE_TAG} ${{ env.ACR_IMAGE }}:${TARGET_TAG}
          docker tag ${{ env.ACR_IMAGE }}:${SOURCE_TAG} ${{ env.ACR_IMAGE }}:${TARGET}

          echo "ðŸ“¤ Pushing..."
          docker push ${{ env.ACR_IMAGE }}:${TARGET_TAG}
          docker push ${{ env.ACR_IMAGE }}:${TARGET}

          echo "âœ… Promoted in ACR:"
          echo "   - ${{ env.ACR_IMAGE }}:${TARGET_TAG}"
          echo "   - ${{ env.ACR_IMAGE }}:${TARGET}"

      - name: Promote in Docker Hub
        if: github.event.inputs.push_to == 'dockerhub' || github.event.inputs.push_to == 'both'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.environment }}"

          # Source tag
          if [ "$SOURCE" == "prod" ]; then
            SOURCE_TAG="v${VERSION}"
          else
            SOURCE_TAG="v${VERSION}-${SOURCE}"
          fi

          # Target tag
          if [ "$TARGET" == "prod" ]; then
            TARGET_TAG="v${VERSION}"
          else
            TARGET_TAG="v${VERSION}-${TARGET}"
          fi

          echo "ðŸ”„ Pulling ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG}..."
          docker pull ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG}

          echo "ðŸ·ï¸  Tagging as ${TARGET_TAG}..."
          docker tag ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG} ${{ env.DOCKERHUB_IMAGE }}:${TARGET_TAG}
          docker tag ${{ env.DOCKERHUB_IMAGE }}:${SOURCE_TAG} ${{ env.DOCKERHUB_IMAGE }}:${TARGET}

          echo "ðŸ“¤ Pushing..."
          docker push ${{ env.DOCKERHUB_IMAGE }}:${TARGET_TAG}
          docker push ${{ env.DOCKERHUB_IMAGE }}:${TARGET}

          echo "âœ… Promoted in Docker Hub:"
          echo "   - ${{ env.DOCKERHUB_IMAGE }}:${TARGET_TAG}"
          echo "   - ${{ env.DOCKERHUB_IMAGE }}:${TARGET}"

      - name: Promote Summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE="${{ github.event.inputs.source_env }}"
          TARGET="${{ github.event.inputs.environment }}"

          echo "## ðŸš€ Docker Promote Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Promotion:** \`${SOURCE}\` â†’ \`${TARGET}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What happened" >> $GITHUB_STEP_SUMMARY
          echo "The same Docker image was re-tagged without rebuilding." >> $GITHUB_STEP_SUMMARY
          echo "This ensures the exact same code runs in ${TARGET} as tested in ${SOURCE}." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          if [ "$TARGET" == "prod" ]; then
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            echo "image_tag: v${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
            echo "image_tag: v${VERSION}-${TARGET}" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
