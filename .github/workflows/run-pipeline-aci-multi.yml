name: Run Pipeline in ACI (Multi-Job)

# This workflow runs each pipeline step in a separate ACI container.
# Use this when you need parallel execution or want to inspect each step individually.
# For a simpler single-container approach, use: run-pipeline-aci-single.yml

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Trading symbol (e.g., BTCUSDT, ETHUSDT)'
        required: true
        default: 'BTCUSDT'
      freq:
        description: 'Timeframe (1m, 5m, 1h)'
        required: true
        type: choice
        options:
          - 1m
          - 5m
          - 1h
        default: '5m'
      strategy:
        description: 'Strategy config'
        required: true
        type: choice
        options:
          - conservative
          - aggressive
          - staging
          - quick
        default: 'conservative'
      image_tag:
        description: 'Docker image tag (leave empty for dev-training)'
        required: false
        default: ''
      skip_merge_features:
        description: 'Skip merge+features (use existing data)'
        type: boolean
        default: false
      keep_containers:
        description: 'Keep containers after completion (for debugging)'
        type: boolean
        default: false

env:
  SYMBOL: ${{ github.event.inputs.symbol }}
  FREQ: ${{ github.event.inputs.freq }}
  STRATEGY: ${{ github.event.inputs.strategy }}
  CONFIG_PATH: configs/base_${{ github.event.inputs.strategy }}.jsonc
  IMAGE_TAG: ${{ github.event.inputs.image_tag || 'dev-training' }}

jobs:
  # =============================================================================
  # Job 1: Merge + Features
  # =============================================================================
  merge-features:
    name: 1. Merge + Features
    runs-on: ubuntu-latest
    environment: dev
    if: github.event.inputs.skip_merge_features != 'true'
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables
        id: vars
        run: |
          CONTAINER_NAME="itb-merge-${SYMBOL,,}-${FREQ}"
          FILE_SHARE="data-itb-${FREQ}"
          DATA_MOUNT="/app/DATA_ITB_${FREQ}"
          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT
          echo "file_share=${FILE_SHARE}" >> $GITHUB_OUTPUT
          echo "data_mount=${DATA_MOUNT}" >> $GITHUB_OUTPUT

      - name: Delete old container
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes 2>/dev/null || true

      - name: Run merge + features
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          FILE_SHARE="${{ steps.vars.outputs.file_share }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"

          echo "ðŸš€ Creating container $CONTAINER_NAME..."

          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --image "${{ vars.ACR_LOGIN_SERVER }}/itb-bot:${{ env.IMAGE_TAG }}" \
            --os-type Linux \
            --registry-login-server "${{ vars.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 2 \
            --memory 4 \
            --environment-variables \
              CONFIG_PATH="${{ env.CONFIG_PATH }}" \
              SYMBOL="${{ env.SYMBOL }}" \
              FREQ="${{ env.FREQ }}" \
            --azure-file-volume-share-name "$FILE_SHARE" \
            --azure-file-volume-account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "$DATA_MOUNT" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              cd /app
              echo \"ðŸ“Š Running merge...\"
              python -m scripts.merge -c \"\$CONFIG_PATH\" --symbol \"\$SYMBOL\" --freq \"\$FREQ\"
              echo \"ðŸ§® Running features...\"
              python -m scripts.features -c \"\$CONFIG_PATH\" --symbol \"\$SYMBOL\" --freq \"\$FREQ\"
              echo \"âœ… Merge + Features complete!\"
            '"

      - name: Wait for completion
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "â³ Waiting for container..."

          while true; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "Waiting")

            echo "State: $STATE"
            if [ "$STATE" = "Terminated" ]; then
              EXIT_CODE=$(az container show \
                --name "$CONTAINER_NAME" \
                --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
                --query "containers[0].instanceView.currentState.exitCode" -o tsv)
              echo "Exit code: $EXIT_CODE"
              if [ "$EXIT_CODE" != "0" ]; then exit 1; fi
              break
            fi
            sleep 15
          done

      - name: Get logs
        if: always()
        run: |
          az container logs \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" 2>/dev/null || true

      - name: Cleanup
        if: always() && github.event.inputs.keep_containers != 'true'
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes || true

  # =============================================================================
  # Job 2: Labels
  # =============================================================================
  labels:
    name: 2. Labels
    runs-on: ubuntu-latest
    environment: dev
    needs: merge-features
    if: always() && (needs.merge-features.result == 'success' || needs.merge-features.result == 'skipped')
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables
        id: vars
        run: |
          CONTAINER_NAME="itb-labels-${SYMBOL,,}-${FREQ}"
          FILE_SHARE="data-itb-${FREQ}"
          DATA_MOUNT="/app/DATA_ITB_${FREQ}"
          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT
          echo "file_share=${FILE_SHARE}" >> $GITHUB_OUTPUT
          echo "data_mount=${DATA_MOUNT}" >> $GITHUB_OUTPUT

      - name: Delete old container
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes 2>/dev/null || true

      - name: Run labels
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          FILE_SHARE="${{ steps.vars.outputs.file_share }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"

          echo "ðŸš€ Creating container $CONTAINER_NAME..."

          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --image "${{ vars.ACR_LOGIN_SERVER }}/itb-bot:${{ env.IMAGE_TAG }}" \
            --os-type Linux \
            --registry-login-server "${{ vars.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 2 \
            --memory 4 \
            --environment-variables \
              CONFIG_PATH="${{ env.CONFIG_PATH }}" \
              SYMBOL="${{ env.SYMBOL }}" \
              FREQ="${{ env.FREQ }}" \
            --azure-file-volume-share-name "$FILE_SHARE" \
            --azure-file-volume-account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "$DATA_MOUNT" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              cd /app
              echo \"ðŸ·ï¸ Running labels...\"
              python -m scripts.labels -c \"\$CONFIG_PATH\" --symbol \"\$SYMBOL\" --freq \"\$FREQ\"
              echo \"âœ… Labels complete!\"
            '"

      - name: Wait for completion
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "â³ Waiting for container..."

          while true; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "Waiting")

            echo "State: $STATE"
            if [ "$STATE" = "Terminated" ]; then
              EXIT_CODE=$(az container show \
                --name "$CONTAINER_NAME" \
                --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
                --query "containers[0].instanceView.currentState.exitCode" -o tsv)
              echo "Exit code: $EXIT_CODE"
              if [ "$EXIT_CODE" != "0" ]; then exit 1; fi
              break
            fi
            sleep 15
          done

      - name: Get logs
        if: always()
        run: |
          az container logs \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" 2>/dev/null || true

      - name: Cleanup
        if: always() && github.event.inputs.keep_containers != 'true'
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes || true

  # =============================================================================
  # Job 3: Train
  # =============================================================================
  train:
    name: 3. Train
    runs-on: ubuntu-latest
    environment: dev
    needs: labels
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables
        id: vars
        run: |
          CONTAINER_NAME="itb-train-${SYMBOL,,}-${FREQ}"
          FILE_SHARE="data-itb-${FREQ}"
          DATA_MOUNT="/app/DATA_ITB_${FREQ}"
          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT
          echo "file_share=${FILE_SHARE}" >> $GITHUB_OUTPUT
          echo "data_mount=${DATA_MOUNT}" >> $GITHUB_OUTPUT

      - name: Delete old container
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes 2>/dev/null || true

      - name: Run train
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          FILE_SHARE="${{ steps.vars.outputs.file_share }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"

          echo "ðŸš€ Creating container $CONTAINER_NAME..."

          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --image "${{ vars.ACR_LOGIN_SERVER }}/itb-bot:${{ env.IMAGE_TAG }}" \
            --os-type Linux \
            --registry-login-server "${{ vars.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 2 \
            --memory 4 \
            --environment-variables \
              CONFIG_PATH="${{ env.CONFIG_PATH }}" \
              SYMBOL="${{ env.SYMBOL }}" \
              FREQ="${{ env.FREQ }}" \
            --azure-file-volume-share-name "$FILE_SHARE" \
            --azure-file-volume-account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "$DATA_MOUNT" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              cd /app
              echo \"ðŸŽ“ Running train...\"
              python -m scripts.train -c \"\$CONFIG_PATH\" --symbol \"\$SYMBOL\" --freq \"\$FREQ\"
              echo \"âœ… Train complete!\"
            '"

      - name: Wait for completion
        timeout-minutes: 30
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "â³ Waiting for container..."

          while true; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "Waiting")

            echo "State: $STATE"
            if [ "$STATE" = "Terminated" ]; then
              EXIT_CODE=$(az container show \
                --name "$CONTAINER_NAME" \
                --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
                --query "containers[0].instanceView.currentState.exitCode" -o tsv)
              echo "Exit code: $EXIT_CODE"
              if [ "$EXIT_CODE" != "0" ]; then exit 1; fi
              break
            fi
            sleep 15
          done

      - name: Get logs
        if: always()
        run: |
          az container logs \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" 2>/dev/null || true

      - name: Cleanup
        if: always() && github.event.inputs.keep_containers != 'true'
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes || true

  # =============================================================================
  # Job 4: Predict + Signals
  # =============================================================================
  predict-signals:
    name: 4. Predict + Signals
    runs-on: ubuntu-latest
    environment: dev
    needs: train
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set variables
        id: vars
        run: |
          CONTAINER_NAME="itb-predict-${SYMBOL,,}-${FREQ}"
          FILE_SHARE="data-itb-${FREQ}"
          DATA_MOUNT="/app/DATA_ITB_${FREQ}"
          echo "container_name=${CONTAINER_NAME}" >> $GITHUB_OUTPUT
          echo "file_share=${FILE_SHARE}" >> $GITHUB_OUTPUT
          echo "data_mount=${DATA_MOUNT}" >> $GITHUB_OUTPUT

      - name: Delete old container
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes 2>/dev/null || true

      - name: Run predict + signals
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          FILE_SHARE="${{ steps.vars.outputs.file_share }}"
          DATA_MOUNT="${{ steps.vars.outputs.data_mount }}"

          echo "ðŸš€ Creating container $CONTAINER_NAME..."

          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --image "${{ vars.ACR_LOGIN_SERVER }}/itb-bot:${{ env.IMAGE_TAG }}" \
            --os-type Linux \
            --registry-login-server "${{ vars.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 2 \
            --memory 4 \
            --environment-variables \
              CONFIG_PATH="${{ env.CONFIG_PATH }}" \
              SYMBOL="${{ env.SYMBOL }}" \
              FREQ="${{ env.FREQ }}" \
            --azure-file-volume-share-name "$FILE_SHARE" \
            --azure-file-volume-account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "$DATA_MOUNT" \
            --no-wait \
            --command-line "bash -lc '
              set -e
              cd /app
              echo \"ðŸ”® Running predict...\"
              python -m scripts.predict -c \"\$CONFIG_PATH\" --symbol \"\$SYMBOL\" --freq \"\$FREQ\"
              echo \"ðŸš¦ Running signals...\"
              python -m scripts.signals -c \"\$CONFIG_PATH\" --symbol \"\$SYMBOL\" --freq \"\$FREQ\"
              echo \"âœ… Predict + Signals complete!\"
            '"

      - name: Wait for completion
        run: |
          CONTAINER_NAME="${{ steps.vars.outputs.container_name }}"
          echo "â³ Waiting for container..."

          while true; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
              --query "containers[0].instanceView.currentState.state" -o tsv 2>/dev/null || echo "Waiting")

            echo "State: $STATE"
            if [ "$STATE" = "Terminated" ]; then
              EXIT_CODE=$(az container show \
                --name "$CONTAINER_NAME" \
                --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
                --query "containers[0].instanceView.currentState.exitCode" -o tsv)
              echo "Exit code: $EXIT_CODE"
              if [ "$EXIT_CODE" != "0" ]; then exit 1; fi
              break
            fi
            sleep 15
          done

      - name: Get logs
        if: always()
        run: |
          az container logs \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" 2>/dev/null || true

      - name: Cleanup
        if: always() && github.event.inputs.keep_containers != 'true'
        run: |
          az container delete \
            --name "${{ steps.vars.outputs.container_name }}" \
            --resource-group "${{ vars.AZURE_RESOURCE_GROUP }}" \
            --yes || true

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [merge-features, labels, train, predict-signals]
    if: always()
    steps:
      - name: Pipeline Summary
        run: |
          echo "## ðŸš€ ACI Multi-Job Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Symbol:** \`${{ env.SYMBOL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timeframe:** \`${{ env.FREQ }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** \`${{ env.STRATEGY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ vars.ACR_LOGIN_SERVER }}/itb-bot:${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Merge + Features | ${{ needs.merge-features.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Labels | ${{ needs.labels.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Train | ${{ needs.train.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Predict + Signals | ${{ needs.predict-signals.result }} |" >> $GITHUB_STEP_SUMMARY
