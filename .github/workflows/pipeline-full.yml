name: Full Offline Training

on:
  # push:
  #   branches:
  #     - dev
  # pull_request:
  #   branches:
  #     - dev
  workflow_dispatch:
    inputs:
      symbol:
        description: 'Trading symbol (e.g., BTCUSDT, ETHUSDT)'
        required: true
        default: 'BTCUSDT'
      freq:
        description: 'Timeframe (1m, 5m, 1h)'
        required: true
        type: choice
        options:
          - 1m
          - 5m
          - 1h
        default: '5m'
      strategy:
        description: 'Strategy config'
        required: true
        type: choice
        options:
          - conservative
          - aggressive
          - staging
          - quick
        default: 'conservative'
      pipeline_mode:
        description: 'Pipeline mode'
        required: true
        type: choice
        options:
          - full
          - train-only
          - predict-only
        default: 'full'

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      config_path: ${{ steps.set-config.outputs.config_path }}
    steps:
      - name: Set config path
        id: set-config
        run: |
          STRATEGY="${{ github.event.inputs.strategy || 'conservative' }}"
          CONFIG_PATH="configs/base_${STRATEGY}.jsonc"
          echo "config_path=$CONFIG_PATH" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ Config: $CONFIG_PATH"
          echo "ğŸ“Š Symbol: ${{ github.event.inputs.symbol || 'BTCUSDT' }}"
          echo "â±ï¸ Freq: ${{ github.event.inputs.freq || '5m' }}"

  merge_features:
    name: Merge + Features
    needs: setup
    if: ${{ github.event.inputs.pipeline_mode != 'predict-only' }}
    uses: ./.github/workflows/step-merge-features.yml
    secrets: inherit
    with:
      config_path: ${{ needs.setup.outputs.config_path }}
      symbol: ${{ github.event.inputs.symbol || 'BTCUSDT' }}
      freq: ${{ github.event.inputs.freq || '5m' }}

  labels:
    name: Labels
    needs: [setup, merge_features]
    if: ${{ github.event.inputs.pipeline_mode != 'predict-only' }}
    uses: ./.github/workflows/step-labels.yml
    secrets: inherit
    with:
      config_path: ${{ needs.setup.outputs.config_path }}
      symbol: ${{ github.event.inputs.symbol || 'BTCUSDT' }}
      freq: ${{ github.event.inputs.freq || '5m' }}

  train:
    name: Train
    needs: [setup, labels]
    if: ${{ github.event.inputs.pipeline_mode != 'predict-only' }}
    uses: ./.github/workflows/step-train.yml
    secrets: inherit
    with:
      config_path: ${{ needs.setup.outputs.config_path }}
      symbol: ${{ github.event.inputs.symbol || 'BTCUSDT' }}
      freq: ${{ github.event.inputs.freq || '5m' }}

  predict_signals:
    name: Predict + Signals
    needs: [setup, train]
    if: ${{ always() && (github.event.inputs.pipeline_mode == 'full' || github.event.inputs.pipeline_mode == 'predict-only') }}
    uses: ./.github/workflows/step-predict-signals.yml
    secrets: inherit
    with:
      config_path: ${{ needs.setup.outputs.config_path }}
      symbol: ${{ github.event.inputs.symbol || 'BTCUSDT' }}
      freq: ${{ github.event.inputs.freq || '5m' }}
