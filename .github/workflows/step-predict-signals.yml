name: Step - Predict + Signals

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Config file (e.g., configs/base_conservative.jsonc)"
        required: true
        default: "configs/base_conservative.jsonc"
  workflow_call:
    inputs:
      config_path:
        description: "Config file path"
        required: true
        type: string
      image_tag:
        description: "Image tag (unused, kept for compatibility)"
        required: false
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  predict_signals:
    name: Predict + Signals
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-train.txt

      - name: Download data from Azure Files
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          az extension add --name storage-preview 2>/dev/null || true
          echo "üì• Downloading data from Azure Files..."
          # Download matrix and models
          az storage file download-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --source data-itb-1m \
            --destination ./DATA_ITB_1m || echo "‚ö†Ô∏è No data files found"

      - name: Run predict
        run: |
          CONFIG="${{ inputs.config_path || github.event.inputs.config_path }}"
          echo "üîÆ Running predict with config: $CONFIG"
          python -m scripts.predict -c "$CONFIG"

      - name: Run signals
        run: |
          CONFIG="${{ inputs.config_path || github.event.inputs.config_path }}"
          echo "üìà Running signals with config: $CONFIG"
          python -m scripts.signals -c "$CONFIG"

      - name: Upload results to Azure Files
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        run: |
          echo "üì§ Uploading results to Azure Files..."
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --destination data-itb-1m \
            --source ./DATA_ITB_1m \
            --pattern "*/predictions.*" || true
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --destination data-itb-1m \
            --source ./DATA_ITB_1m \
            --pattern "*/signals.*" || true
          az storage file upload-batch \
            --account-name "$AZURE_STORAGE_ACCOUNT" \
            --account-key "$AZURE_STORAGE_KEY" \
            --destination data-itb-1m \
            --source ./DATA_ITB_1m \
            --pattern "*/signal_models.*" || echo "‚ö†Ô∏è Upload completed"
