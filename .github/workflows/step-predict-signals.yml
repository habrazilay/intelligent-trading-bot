name: Step - Predict + Signals

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Config file (e.g., configs/base_conservative.jsonc)"
        required: true
        default: "configs/base_conservative.jsonc"
      symbol:
        description: "Trading symbol (e.g., BTCUSDT)"
        required: true
        default: "BTCUSDT"
      freq:
        description: "Timeframe (1m, 5m, 1h)"
        required: true
        default: "5m"
  workflow_call:
    inputs:
      config_path:
        description: "Config file path"
        required: true
        type: string
      symbol:
        description: "Trading symbol"
        required: true
        type: string
      freq:
        description: "Timeframe"
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  predict_signals:
    name: Predict + Signals
    runs-on: ubuntu-latest
    environment: dev
    env:
      CONFIG: ${{ inputs.config_path || github.event.inputs.config_path || 'configs/base_conservative.jsonc' }}
      SYMBOL: ${{ inputs.symbol || github.event.inputs.symbol || 'BTCUSDT' }}
      FREQ: ${{ inputs.freq || github.event.inputs.freq || '5m' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install TA-Lib system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential wget
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=/usr
          make
          sudo make install
          cd ..
          rm -rf ta-lib ta-lib-0.4.0-src.tar.gz

      - name: Install dependencies
        run: pip install -r requirements-train.txt

      - name: Download data from Azure Files
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "ðŸ“¥ Downloading from share: $SHARE_NAME/${SYMBOL}"
          mkdir -p "$LOCAL_DIR"

          az storage file download-batch \
            --account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --source "$SHARE_NAME/${SYMBOL}" \
            --destination "$LOCAL_DIR"

      - name: Run predict
        run: |
          echo "ðŸ”® Running predict: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.predict -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Run signals
        run: |
          echo "ðŸ“ˆ Running signals: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.signals -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Run simulate
        run: |
          echo "ðŸ“Š Running simulate: $CONFIG --symbol $SYMBOL --freq $FREQ"
          python -m scripts.simulate -c "$CONFIG" --symbol "$SYMBOL" --freq "$FREQ"

      - name: Upload results to Azure Files
        run: |
          SHARE_NAME="data-itb-${FREQ}"
          LOCAL_DIR="./DATA_ITB_${FREQ}/${SYMBOL}"
          echo "ðŸ“¤ Uploading to share: $SHARE_NAME/${SYMBOL}"
          az storage file upload-batch \
            --account-name "${{ vars.AZURE_STORAGE_ACCOUNT }}" \
            --account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --destination "$SHARE_NAME" \
            --destination-path "$SYMBOL" \
            --source "$LOCAL_DIR"
