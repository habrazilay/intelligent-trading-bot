name: Step - Predict + Signals

on:
  workflow_dispatch:
    inputs:
      config_path:
        description: "Path to JSONC config file (e.g. configs/btcusdt_1m_dev.jsonc)"
        required: true
        default: "configs/btcusdt_1m_dev.jsonc"
      image_tag:
        description: "Image tag (e.g., v1.0.0-dev, dev)"
        required: true
        default: "dev"
  workflow_call:
    inputs:
      config_path:
        description: "Path to JSONC config file"
        required: true
        type: string
      image_tag:
        description: "Image tag"
        required: true
        type: string

env:
  ACR_LOGIN_SERVER: itbacr.azurecr.io
  ACR_REPOSITORY: itb-bot
  DOCKER_IMAGE: itbacr.azurecr.io/itb-bot:${{ inputs.image_tag || github.event.inputs.image_tag }}
  AZURE_RESOURCE_GROUP: rg-itb-dev
  AZURE_CONTAINER_PREFIX: itb-bot
  AZURE_STORAGE_ACCOUNT: stitbdev
  AZURE_FILE_SHARE: data-itb-1m
  DATA_MOUNT_PATH: /app/DATA_ITB_1m

jobs:
  predict_signals_only:
    runs-on: ubuntu-latest
    env:
      CONFIG_PATH: ${{ inputs.config_path || github.event.inputs.config_path }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run predict + signals in Azure Container Instance
        run: |
          CONTAINER_NAME=${{ env.AZURE_CONTAINER_PREFIX }}-predict-signals-only

          echo "CONFIG_PATH=$CONFIG_PATH"
          echo "ðŸ§¹ Deleting previous predict-signals-only container (if exists)..."
          az container delete \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --yes || true

          echo "ðŸ”„ Creating predict-signals-only container $CONTAINER_NAME with image $DOCKER_IMAGE..."
          az container create \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
            --image "$DOCKER_IMAGE" \
            --os-type Linux \
            --registry-login-server "${{ env.ACR_LOGIN_SERVER }}" \
            --registry-username "${{ secrets.ACR_USERNAME }}" \
            --registry-password "${{ secrets.ACR_PASSWORD }}" \
            --restart-policy Never \
            --cpu 1 \
            --memory 2 \
            --azure-file-volume-share-name "${{ env.AZURE_FILE_SHARE }}" \
            --azure-file-volume-account-name "${{ env.AZURE_STORAGE_ACCOUNT }}" \
            --azure-file-volume-account-key "${{ secrets.AZURE_STORAGE_KEY }}" \
            --azure-file-volume-mount-path "${{ env.DATA_MOUNT_PATH }}" \
            --no-wait \
            --command-line "sh -c 'python -m scripts.predict -c $CONFIG_PATH && python -m scripts.signals -c $CONFIG_PATH'"

          echo "â³ Waiting for predict-signals-only container final state..."
          for i in {1..60}; do
            STATE=$(az container show \
              --name "$CONTAINER_NAME" \
              --resource-group "${{ env.AZURE_RESOURCE_GROUP }}" \
              --query 'instanceView.state' -o tsv 2>/dev/null || echo "Pending")
            echo "[$i] Container state: $STATE"
            if [ "$STATE" = "Terminated" ] || [ "$STATE" = "Succeeded" ] || [ "$STATE" = "Failed" ]; then
              break
            fi
            sleep 5
          done

          echo "ðŸ“œ predict-signals-only container logs:"
          az container logs \
            --name "$CONTAINER_NAME" \
            --resource-group "${{ env.AZURE_RESOURCE_GROUP }}"